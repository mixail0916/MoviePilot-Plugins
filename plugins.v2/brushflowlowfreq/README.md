# 站点刷流（低频版）

在官方刷流插件的基础上，新增了若干项功能优化了部分细节逻辑，目前已逐步PR至官方插件。在此，再次感谢 [@jxxghp](https://github.com/jxxghp) 提供那么优秀的开源作品。

**请注意，本文档仅适用于 `MoviePilot.v2` 站点刷流插件，`MoviePilot.v1` 站点刷流插件，详情见 [v1插件](../../plugins/brushflowlowfreq/README.md)**

## 版本更新日志

- v4.3
  - 优化执行周期输入，需要MoviePilot v2.2.1+

- v4.2
  - 支持带宽采样并计算平均值，以优化刷流效率

- v4.1
  - 支持通过CRON表达式配置开启时间，固定10分钟为执行周期

- v4.0
  - 站点独立配置项支持配置NexusPHP 站点自动跳过下载提示页

- v3.9
  - MoviePilot V2 版本站点刷流（低频版）插件  
  
## 开发计划

- [ ] **站点独立配置支持保种体积**：新增保种体积配置，删除种子时按站点独立配置执行。若站点未配置保种体积，则使用全局配置。
- [x] **适配跳过站点提示页**：部分站点存在下载种子提示页，新增自动跳过功能。
- [ ] **自定义 RSS 支持**：针对部分站点首页置顶过多的问题，通过配置 RSS 实现刷流逻辑（不支持免费、H&R 等需要解析种子网页的规则）。

## 定时服务

- **刷流服务**：每 10 分钟运行一次，用于请求站点下载刷流种子。
- **刷流检查服务**：每 5 分钟运行一次，用于同步检查下载器的刷流种子信息、删除种子和更新统计。

## 配置说明

| 配置项                 | 标识                 | 说明                                 | 备注                                                                                                              |
| ---------------------- | -------------------- | ------------------------------------ | ----------------------------------------------------------------------------------------------------------------- |
| 启用插件               | `enabled`            | 控制插件是否启用                     |                                                                                                                   |
| 发送通知               | `notify`             | 是否启用发送通知功能                 |                                                                                                                   |
| 立即运行一次           | `onlyonce`           | 立即运行一次操作                     | 刷流和刷流检查服务均会执行                                                                                        |
| 刷流站点               | `brushsites`         | 选择要刷流的站点                     | 若未选择站点但启用了插件，刷流服务不会执行，但刷流检查服务会正常运行                                              |
| 下载器                 | `downloader`         | 选择使用的下载客户端                 |                                                                                                                   |
| 保种体积（GB）         | `disksize`           | 刷流任务达到指定体积后停止刷流       | 保种体积 >（刷流任务体积 + 种子大小下限）时允许继续刷流                                                           |
| 种子分类               | `qb_category`        | 刷流推送下载器的种子分类             | 仅支持 QB，配置后保存目录配置项失效，需提前在下载器中创建                                                         |
| 促销                   | `freeleech`          | 根据促销类型过滤任务                 | 包括全部、免费和 2X 免费，免费包括 2X 免费                                                                                         |
| 排除 H&R               | `hr`                 | 是否排除有 H&R 要求的任务            |                                                                                                                   |
| 总上传带宽（KB/s）     | `maxupspeed`         | 达到设定的上传带宽后停止刷流         |                                                                                                                   |
| 总下载带宽（KB/s）     | `maxdlspeed`         | 达到设定的下载带宽后停止刷流         |                                                                                                                   |
| 同时下载任务数         | `maxdlcount`         | 设置同时下载的最大任务数             |                                                                                                                   |
| 包含规则               | `include`            | 设置刷流包含的规则（支持正则表达式） | 种子标题或副标题任一匹配即可                                                                                      |
| 排除规则               | `exclude`            | 设置刷流排除的规则（支持正则表达式） | 种子标题或副标题任一匹配即可                                                                                      |
| 种子大小（GB）         | `size`               | 设置任务的种子大小过滤               | 示例：<br>5，种子体积 ≥ 5GB <br> 5-10，5GB ≤ 种子体积 ≤ 10GB                                                      |
| 做种人数               | `seeder`             | 设置做种人数过滤                     | 示例：<br>5，做种人数 ≤ 5 <br> 5-10，5 ≤ 做种人数 ≤ 10                                                            |
| 发布时间（分钟）       | `pubtime`            | 设置任务的发布时间过滤               | 示例：<br>5，发布时间 ≤ 5 <br> 5-10，5 ≤ 发布时间 ≤ 10                                                            |
| 站点全局 H&R           | `site_hr_active`     | 标记站点是否开启全局 H&R             | 开启后新增的刷流任务会标记为 H&R 种子，仅联动删种规则，不会联动「排除 H&R」选项和消息推送                         |
| 忽略站点提示           | `site_skip_tips`     | 是否忽略站点下载提示                 | 开启后，支持部分 NexusPHP 站点忽略下载提示，如低分享率等场景                                                      |
| 做种时间（小时）       | `seed_time`          | 达到指定做种时间后删除任务           |                                                                                                                   |
| H&R 做种时间（小时）   | `hr_seed_time`       | 对 H&R 任务，达到指定做种时间后删除  | 如果未配置 H&R 做种时间/分享率，则普通种子的删除规则也适用于 H&R 种子                                             |
| 动态删种阈值（GB）     | `delete_size_range`  | 设置动态删种的体积阈值               | 详情见[动态删除规则](#动态删除规则)                                                                               |
| 分享率                 | `seed_ratio`         | 达到设定分享率后删除任务             |                                                                                                                   |
| 上传量（GB）           | `seed_size`          | 达到设定上传量后删除任务             |                                                                                                                   |
| 下载超时时间（小时）   | `download_time`      | 达到指定下载超时时间后删除任务       |                                                                                                                   |
| 平均上传速度（KB/s）   | `seed_avgspeed`      | 低于设定平均上传速度时删除任务       | 刷流任务做种 30 分钟后生效                                                                                        |
| 未活动时间（分钟）     | `seed_inactivetime`  | 超过设定未活动时间后删除任务         |                                                                                                                   |
| 删除排除标签           | `delete_except_tags` | 删除任务时排除的种子任务标签         | 默认值为 MOVIEPILOT,H&R，用于联动 H&R 助手或 MoviePilot 任务                                                      |
| 单任务上传限速（KB/s） | `up_speed`           | 设置每个种子的上传限速               |                                                                                                                   |
| 单任务下载限速（KB/s） | `dl_speed`           | 设置每个种子的下载限速               |                                                                                                                   |
| 保存目录               | `save_path`          | 设置种子保存目录                     |                                                                                                                   |
| 自动归档记录天数       | `auto_archive_days`  | 定时归档已删除种子任务               |                                                                                                                   |
| 开启时间段             | `active_time_range`  | 设置插件刷流的活动时间段             | 示例：00:00-08:00                                                                                                 |
| 执行周期               | `cron`               | 设置插件刷流的活动周期               | 执行周期固定为 10 分钟，配置项仅用于设置活动周期。例如：`0 0-1 * * FRI,SUN`，建议使用标准缩写（如 `FRI`）表示星期 |
| 站点顺序刷流           | `brush_sequential`   | 是否按站点顺序刷流                   | 关闭选项时，按站点随机顺序刷流                                                                                    |
| 排除订阅               | `except_subscribe`   | 刷流时排除订阅内容相关的种子         | **实验性功能**，开启后可能导致刷流时无法正常下载种子                                                              |
| 动态删除种子           | `proxy_delete`       | 是否启用动态删除种子                 | **实验性功能**，可能导致刷流数据异常，甚至清空数据，请慎重开启。详情见[动态删除规则](#动态删除规则)               |
| 清除统计数据           | `clear_task`         | 是否清除统计数据                     | 一次性任务，自动重置插件数据页中的所有数据                                                                        |
| 站点独立配置           | `enable_site_config` | 是否启用站点独立配置                 | 详情见[站点独立配置](#站点独立配置)                                                                               |
| 打开站点配置窗口       | `dialog_closed`      | 控制站点独立配置页面的显示状态       | 点击后可打开站点独立配置页面                                                                                      |
| 双向同步官方插件数据   | `sync_official`      | 是否双向同步官方插件数据             | 如存在重复任务，默认以本插件的任务为准                                                                            |

## 动态删除规则

- 开启动态删除种子和设置动态删除阈值后

，动态删除规则开始生效：
  1. 无论做种体积是否超过阈值，优先执行排除 H&R 种子后满足「下载超时时间」的种子。
  2. 执行完上述规则后，若做种体积仍超过阈值，继续执行下述规则。
  3. 优先删除满足用户配置删除规则的种子，即使删除过程中体积已低于阈值，也会继续删除。
  4. 若删除后仍未达到阈值，则在已完成的种子中排除 H&R 种子后按做种时间倒序删除。
  5. 动态删除阈值示例：
     - 阈值 100GB：当做种体积 > 100GB 时，开始删除种子，直至体积降至 100GB。
     - 阈值 50-100GB：当做种体积 > 100GB 时，开始删除种子，直至体积降至 50GB。

## 站点独立配置

站点独立配置支持以下配置项。配置格式为 JSON，通过 `sitename` 进行匹配。若未找到对应配置项，则以全局配置为准。**请注意，与全局保持一致的配置项不应在站点配置中重复配置。为确保配置正确，可开启 `DEBUG` 日志进行排查**。

- `sitename`：站点名称
- `freeleech`：促销类型
  - `''`：全部
  - `'free'`：免费
  - `'2xfree'`：2X 免费
- `hr`：排除 H&R
  - `'yes'`：是
  - `'no'`：否
- `include`：包含规则
- `exclude`：排除规则
- `size`：种子大小
- `seeder`：做种人数
- `pubtime`：发布时间
- `seed_time`：做种时间
- `seed_ratio`：分享率
- `seed_size`：上传量
- `download_time`：下载超时时间
- `seed_avgspeed`：平均上传速度
- `seed_inactivetime`：未活动时间
- `save_path`：保存目录
- `proxy_delete`：动态删除种子（实验性功能）
- `hr_seed_time`：H&R 做种时间
- `qb_category`：种子分类
- `site_hr_active`：站点全局 H&R
- `site_skip_tips`：忽略站点提示

### 配置示例

```json
// 以下为配置示例，请参考：https://github.com/InfinityPacer/MoviePilot-Plugins/blob/main/README.md 进行配置
// 如与全局保持一致的配置项，请勿在站点配置中配置
// 注意无关内容需使用 // 注释
[{
    "sitename": "站点1",
    "seed_time": 96,
    "hr_seed_time": 144
}, {
    "sitename": "站点2",
    "hr": "yes",
    "size": "10-500",
    "seeder": "5-10",
    "pubtime": "5-120",
    "seed_time": 96,
    "save_path": "/downloads/site2",
    "hr_seed_time": 144
}, {
    "sitename": "站点3",
    "freeleech": "free",
    "hr": "yes",
    "include": "",
    "exclude": "",
    "size": "10-500",
    "seeder": "1",
    "pubtime": "5-120",
    "seed_time": 120,
    "hr_seed_time": 144,
    "seed_ratio": "",
    "seed_size": "",
    "download_time": "",
    "seed_avgspeed": "",
    "seed_inactivetime": "",
    "save_path": "/downloads/site1",
    "proxy_delete": false,
    "qb_category": "刷流",
    "site_hr_active": true,
    "site_skip_tips": true
}]
```

## 注意事项

  - **启用官方刷流插件时，本插件无法正常使用，可尝试停用官方插件后通过双向同步官方插件数据再开启使用，请不要同时启用两个插件，否则可能导致种子异常甚至数据丢失！**
  - **排除H&R并不保证能完全适配所有站点（部分站点在列表页不显示H&R标志，但实际上是有H&R的），请注意核对使用！**

## FAQ
  
- **官版和低频版有什么区别？**
  - 低频版是在官版 v1.4 的基础上进行的二次开发，目前已逐步向官方仓库提交 PR。低频版的更新速度相对更快，除数据页外，短期内功能上与官版基本无差别。

- **如何开启 `DEBUG` 日志？**
  - 请在环境变量或 DEV 文件中，添加 `DEBUG=true` 或 `LOG_LEVEL=DEBUG` 配置项。

- **为什么我配置了刷流，但没有下载到种子，或者下载的种子不符合我的规则？**
  - 请开启 `DEBUG` 日志，并根据日志排查问题。
  - 尝试在 MP 中，进入站点管理->对应站点->浏览，检查是否能够正常浏览种子。
  - 如果配置了「发布时间」，但某些站点（如 OB、Frds）的时区为 UTC+0，请通过日志排查确认时间是否为 UTC+0。如果确认为 UTC+0，可通过站点独立配置「pubtime」，如 480-530 来适配。

- **为什么我在站点中配置了 RSS，但刷流没有按 RSS 执行？**
  - 目前刷流插件不支持 RSS 功能，请关注后续开发计划。

- **为什么我配置了站点独立配置，但没有生效，且插件自动关闭了？**
  - 请开启 `DEBUG` 日志，并根据日志排查问题。

- **为什么刷流日志中提示「获取种子 Hash 失败」「添加刷流任务失败」「不是有效的 torrent 文件」等错误，且下载器中没有添加刷流任务？**
  - 请检查 MP 与下载器的连接是否正常。
  - 检查 QB 日志是否有异常。
  - 某些站点首次下载种子时需要在网页上确认下载提示，请确认不是首次下载。
  - 尝试在 MP 中，进入站点管理->对应站点->浏览，找到种子并点击下载，确认是否能正常下载。

- **为什么下载器中经常出现乱码标签？**
  - 由于 qBittorrent 的添加种子接口没有返回种子 Hash，目前通过随机标签获取种子 Hash 以便后续刷流管理。当下载器连接性较差时，可能会出现超时，导致种子已经开始下载，但 MP 未获取到相应信息，从而认为种子未下载，随机标签未被删除。

- **为什么我被标记 H&R 了，会不会被封号？**
  - H&R 的排除功能不保证适配所有站点（部分站点列表页不显示 H&R 标志，但实际上存在 H&R 风险）。
  - 请查看各站点的 H&R 规则以了解详情。

- **为什么选择只刷免费种，但仍然统计了下载量？**
  - 请检查是否被标记为盒子种子。
  - 检查种子的免费期限是否已结束。

- **为什么被标记为盒子种子了？**
  - 请检查下载器的网络环境是否正常。

- **为什么开启了动态删除种子，结果我的种子全被删除了？**
  - 该功能为实验性功能，目前删除规则还在不断优化调整中，可能会导致刷流数据异常，甚至清空种子，请谨慎使用。
  - 目前的删除规则是：当做种体积超过动态删除阈值时，系统会按**用户设置的删除规则**优先删除所有符合条件的种子，即使在删除过程中体积已低于阈值，也会继续执行删除操作。
  - 如果删除后仍未达到阈值，系统会在已完成的种子中，排除 H&R 种子后，按做种时间倒序删除。

- **为什么刷流插件不支持配置标签？**
  - 请使用「种子关键字分类整理」、「下载任务分类和标签」、「下载器助手」插件。

- **为什么种子在站点显示为免费，但在刷流日志中提示为非免费种子，或者促销条件与站点不符？**
  - 请检查免费期是否已结束。
  - 尝试在 MP 中，进入站点管理->对应站点->浏览，找到种子并查看促销条件是否与站点一致。如不一致，请在 [MoviePilot](https://github.com/jxxghp/MoviePilot/issues) 反馈适配问题。

- **为什么配置了选种规则，但未按规则执行？**
  - 请开启 `DEBUG` 日志，并根据日志排查问题。
  - 部分种子可能会在发布后修改促销条件或 H&R 状态，请检查日志并确认。
  - 尝试在 MP 中，进入站点管理->对应站点->浏览，找到种子并核对信息。如不一致，可在 [MoviePilot](https://github.com/jxxghp/MoviePilot/issues) 反馈适配问题。

- **为什么刷流插件显示的种子信息与站点信息不一致？**
  - 请开启 `DEBUG` 日志，并根据日志排查问题。
  - 部分种子可能在发布后修改了促销条件或 H&R 状态，请查看日志进行排查。
  - 尝试在 MP 中，进入站点管理->对应站点->浏览，查看种子相关信息与站点是否一致。如不一致，请在 [MoviePilot](https://github.com/jxxghp/MoviePilot/issues) 反馈适配问题。

- **为什么配置了保存目录，但仍然保存到了 QB 的默认下载目录？**
  - 请检查下载器是否开启了「自动分类管理」，开启后下载目录由 QB 管理，此时「保存目录」配置项将失效。请提前在 QB 中配置相关选项。

![](../../images/2024-05-02-03-16-42.png)
