# 站点刷流（低频版）

在官方刷流插件的基础上，新增了若干项功能优化了部分细节逻辑，目前已逐步PR至官方插件。在此，再次感谢 [@jxxghp](https://github.com/jxxghp) 提供那么优秀的开源作品。

**请注意，本文档仅适用于MoviePilot.v2站点刷流插件，MoviePilot.v1站点刷流插件，详情见 [v1插件](../../plugins/brushflowlowfreq/README.md)**

## 版本更新日志

- v3.9
  - MoviePilot V2 版本站点刷流（低频版）插件  
  
## 开发计划

- [ ] **动态删除种子（实验性功能）规则调整**：已调整部分规则，评估即便没有触发删除阈值，也按对应的删种条件执行删除操作，即如果用户配置了删除条件，则每次刷流检查服务都会按用户设置的条件执行删除操作（排除H&R种子），然后再执行动态删除逻辑
- [ ] **刷流辅种删除优化**：如果其他站点在辅种且不满足删种条件，则跳过
- [ ] **站点独立配置支持保种体积**：在站点独立配置中，增加保种体积的支持，在删除种子时，根据站点独立配置进行删除，如果部分站点没有配置保种体积的，以全局配置为准
- [ ] **适配跳过站点首次下载**：部分站点存在首次下载种子提示页，支持自动跳过
- [ ] **自定义RSS**：部分站点首页置顶过多，无法有效刷流，通过配置RSS来实现刷流逻辑（不支持免费、H&R等需要解析种子网页的规则）

## 定时服务

  - 刷流服务，每10分钟运行一次，用于请求站点下载刷流种子。
  - 刷流检查服务，每5分钟运行一次，用于同步检查下载器刷流种子信息，删除种子，更新统计等。

## 配置说明

| 配置项                 | 标识                  | 说明                                       | 备注                                                                                                                 |
| ---------------------- | --------------------- | ------------------------------------------ | -------------------------------------------------------------------------------------------------------------------- |
| 启用插件               | `enabled`             | 控制插件是否启用                           |                                                                                                                      |
| 发送通知               | `notify`              | 是否启用发送通知功能                       |                                                                                                                      |
| 立即运行一次           | `onlyonce`            | 立即运行一次操作                           | 刷流&刷流检查服务均会执行                                                                                            |
| 刷流站点               | `刷流sites`           | 选择要刷流的站点                           | 没有选择站点，但是启用插件时，刷流服务不会执行，刷流检查服务会正常执行                                               |
| 下载器                 | `downloader`          | 选择使用的下载客户端                       |                                                                                                                      |
| 保种体积（GB）         | `disksize`            | 刷流任务（正常）达到指定体积后停止刷流任务 | 保种体积 > (刷流任务体积 + 种子大小下限) 时，允许继续刷流任务                                                        |
| 种子分类               | `qb_category`         | 刷流推送下载器的种子分类                   | 仅支持QB，配置后保存目录配置项失效，需提前在下载器中创建                                                             |
| 促销                   | `freeleech`           | 根据促销类型过滤任务                       | 包括全部、免费、2X免费。免费包括2X免费                                                                               |
| 排除H&R                | `hr`                  | 是否排除有H&R（Hit and Run）要求的任务     |                                                                                                                      |
| 总上传带宽（KB/s）     | `maxupspeed`          | 达到设定的上传带宽后停止刷流任务           |                                                                                                                      |
| 总下载带宽（KB/s）     | `maxdlspeed`          | 达到设定的下载带宽后停止刷流任务           |                                                                                                                      |
| 同时下载任务数         | `maxdlcount`          | 设置同时下载的最大任务数                   |                                                                                                                      |
| 包含规则               | `include`             | 设置包含的刷流规则（支持正则表达式）       | 种子标题、副标题任一匹配                                                                                             |
| 排除规则               | `exclude`             | 设置排除的刷流规则（支持正则表达式）       | 种子标题、副标题任一匹配                                                                                             |
| 种子大小（GB）         | `size`                | 设置任务的种子大小过滤                     | 示例：<br>5，种子体积 >= 5GB <br> 5-10，5GB <= 种子体积 <= 10GB                                                      |
| 做种人数               | `seeder`              | 设置做种人数过滤                           | 示例：<br>5，做种人数 <= 5 <br> 5-10，5 <= 做种人数 <= 10                                                            |
| 发布时间（分钟）       | `pubtime`             | 设置任务的发布时间过滤                     | 示例：<br>5，发布时间 <= 5 <br> 5-10，5 <= 发布时间 <= 10 <br> 部分站点时间为UTC+0，可通过配置项「pubtime」自行适配  |
| 站点全局H&R            | `site_hr_active`      | 站点独立配置项，标记站点是否开启全局H&R    | 开启后新增的刷流任务会标记为H&R种子，可在数据页查看是否已被标记，仅联动删种规则，不会联动「排除H&R」选项以及消息推送 |
| 做种时间（小时）       | `seed_time`           | 达到指定做种时间后删除任务                 |                                                                                                                      |
| H&R做种时间（小时）    | `hr_seed_time`        | 对于H&R任务，达到指定做种时间后删除任务    | 如果没有配置H&R做种时间/分享率，则普通种子的删除规则也适用于H&R种子                                                  |
| 动态删种阈值（GB）     | `delete_size_range`   | 设置动态删种的体积阈值                     | 见[动态删除规则](#动态删除规则)                                                                                      |
| 分享率                 | `seed_ratio`          | 达到设定分享率后删除任务                   | 如果没有配置H&R做种时间/分享率，则普通种子的删除规则也适用于H&R种子                                                  |
| 上传量（GB）           | `seed_size`           | 达到设定上传量后删除任务                   |                                                                                                                      |
| 下载超时时间（小时）   | `download_time`       | 达到指定下载超时时间后删除任务             |                                                                                                                      |
| 平均上传速度（KB/s）   | `seed_avgspeed`       | 低于设定的平均上传速度时删除任务           | 刷流任务做种30分钟后才会生效                                                                                         |
| 未活动时间（分钟）     | `seed_inactivetime`   | 超过设定的未活动时间后删除任务             |                                                                                                                      |
| 删除排除标签           | `delete_except_tags`  | 删除任务时排除的种子任务标签               | 默认值为MOVIEPILOT,H&R，可用于联动H&R助手或MoviePilot任务                                                            |
| 单任务上传限速（KB/s） | `up_speed`            | 设置每个种子的上传限速                     |                                                                                                                      |
| 单任务下载限速（KB/s） | `dl_speed`            | 设置每个种子的下载限速                     |                                                                                                                      |
| 保存目录               | `save_path`           | 设置种子保存的目录                         |
| 开启时间段             | `active_time_range`   | 设置插件刷流和刷流检查的活动时间段         | 如00:00-08:00                                                                                                        |
| 站点顺序刷流           | `刷流_sequential`     | 是否按选择的站点顺序进行刷流               | 关闭选项时，按选择的站点随机顺序进行刷流                                                                             |
| 排除订阅               | `except_subscribe`    | 刷流时排除订阅内容的相关种子               | **实验性功能**，可能会导致刷流时无法正常下载种子，请慎重开启                                                         |
| 动态删除种子           | `proxy_delete`        | 是否启用动态删除种子                       | **实验性功能**，可能会导致刷流数据异常，甚至清空，请慎重开启，见[动态删除规则](#动态删除规则)                        |
| 清除统计数据           | `clear_task`          | 是否启用清除统计数据功能                   | 一次性任务，自动将插件数据页中的所有数据重置后，配置项重置为关闭                                                     |
| 站点独立配置           | `enable_site_config`  | 是否启用站点独立配置                       | 见[站点独立配置](#站点独立配置)                                                                                      |
| 打开站点配置窗口       | `dialog_closed`       | 控制站点独立配置页面的显示状态             | 点击即可打开站点独立配置页面的窗口                                                                                   |
| 双向同步官方插件数据   | `sync_official`       | 是否启用双向同步官方插件数据的功能         | 将官版以及本插件的刷流任务数据进行合并，如存在重复刷流任务，默认已本插件的为准。                                     |

## 动态删除规则
  - 当开启动态删除种子以及设置动态删除阈值时，动态删除规则开始生效，具体如下：
    - 不管做种体积是否超过设定的动态删除阈值，默认优先执行排除H&R种子后满足「下载超时时间」的种子
    - 上述规则执行完成后，当做种体积依旧超过设定的动态删除阈值时，继续执行下述种子删除规则
    - 优先删除满足用户设置删除规则的全部种子，即便在删除过程中已经低于了阈值下限，也会继续删除
    - 若删除后还没有达到阈值，则在已完成种子中排除H&R种子后按做种时间倒序进行删除
    - 动态删除阈值：100，当做种体积 > 100G 时，则开始删除种子，直至降低至 100G
    - 动态删除阈值：50-100，当做种体积 > 100G 时，则开始删除种子，直至降至为 50G

## 站点独立配置

目前站点独立配置支持以下配置项，配置格式为json，通过sitename进行匹配，没有找到对应配置项时，则以全局配置项为准，**请注意，如与全局保持一致的配置项，请勿在站点配置中配置，此外hr配置项为排除H&R，请按下述内容进行配置，配置完成后，请在日志查看是否配置成功**，可打开 `DEBUG` 日志以便更好排查问题。

- `sitename`: 站点名称
- `freeleech`: 促销
  - `''`: 全部（包括普通）
  - `'free'`: 免费
  - `'2xfree'`: 2X免费
- `hr`: 排除H&R
  - `'yes'`: 是
  - `'no'`: 否
- `include`: 包含规则
- `exclude`: 排除规则
- `size`: 种子大小
- `seeder`: 做种人数
- `pubtime`: 发布时间
- `seed_time`: 做种时间
- `seed_ratio`: 分享率
- `seed_size`: 上传量
- `download_time`: 下载超时时间
- `seed_avgspeed`: 平均上传速度
- `seed_inactivetime`: 未活动时间
- `save_path`: 保存目录
- `proxy_delete`: 动态删除种子（实验性功能）
- `hr_seed_time`: H&R做种时间
- `qb_category`: 种子分类
- `site_hr_active`: 站点全局H&R

配置示例

```json
// 以下为配置示例，请参考：https://github.com/InfinityPacer/MoviePilot-Plugins/blob/main/README.md 进行配置
// 如与全局保持一致的配置项，请勿在站点配置中配置
// 注意无关内容需使用 // 注释
[{
    "sitename": "站点1",
    "seed_time": 96,
    "hr_seed_time": 144
}, {
    "sitename": "站点2",
    "hr": "yes",
    "size": "10-500",
    "seeder": "5-10",
    "pubtime": "5-120",
    "seed_time": 96,
    "save_path": "/downloads/site2",
    "hr_seed_time": 144
}, {
    "sitename": "站点3",
    "freeleech": "free",
    "hr": "yes",
    "include": "",
    "exclude": "",
    "size": "10-500",
    "seeder": "1",
    "pubtime": "5-120",
    "seed_time": 120,
    "hr_seed_time": 144,
    "seed_ratio": "",
    "seed_size": "",
    "download_time": "",
    "seed_avgspeed": "",
    "seed_inactivetime": "",
    "save_path": "/downloads/site1",
    "proxy_delete": false,
    "qb_category": "刷流",
    "site_hr_active": true
}]
```

## 注意事项

  - **启用官方刷流插件时，本插件无法正常使用，可尝试停用官方插件后通过双向同步官方插件数据再开启使用，请不要同时启用两个插件，否则可能导致种子异常甚至数据丢失！**
  - **排除H&R并不保证能完全适配所有站点（部分站点在列表页不显示H&R标志，但实际上是有H&R的），请注意核对使用！**

## FAQ
  
- **官版和低频版有什么区别**？
  - 低频版在官版v1.4基础上二次开发，目前已逐步PR官方仓库，低频版更新速度相对更快，除数据页外，功能上短期内基本无差别。
  
- **如何开启 `DEBUG` 日志？**
  - 请在环境变量或者DEV文件中，增加 `DEBUG=true` 或 `LOG_LEVEL=DEBUG` 配置项

- **为什么我配置了刷流，但是没有种子下载，就算有下载，也不是按我配置的规则下载的种子？**
  - 请开启 `DEBUG` 日志，并根据日志排查问题。
  - 尝试在MP中，进入站点管理->对应站点->浏览，检查是否能够浏览种子。
  - 如果配置了「发布时间」，但部分站点（如 OB、Frds）时区为 UTC+0，请通过日志排查确认是否为 UTC+0。确认后，可以通过站点独立配置「pubtime」，如 480-530 来适配。

- **为什么我在站点中配置了RSS，刷流却没有按RSS来执行？**
  - 目前刷流插件不支持RSS，请关注后续开发计划。

- **为什么我配置了站点独立配置，不但没有生效，插件还自动关闭了？**
  - 请开启 `DEBUG` 日志，并根据日志排查问题。

- **为什么刷流日志中提示「获取种子Hash失败」「添加刷流任务失败」「不是一个有效的 torrent 文件」等等，下载器中也没有刷流任务添加？**
  - 检查MP与下载器的连接是否正常。
  - 检查QB日志是否正常。
  - 部分站点首次下载种子时，需要在对应网页上确认下载提示，请确认不是首次下载。
  - 尝试在MP中，进入站点管理->对应站点->浏览，找到对应的种子，点击下载确认是否正常。

- **为什么下载器中经常出现一些乱码的标签？**
  - qBittorrent的添加种子接口没有返回对应的种子Hash，目前通过打随机标签来获取种子Hash以便后续的刷流管理。下载器连接性不好的时候，可能会出现超时等情况，导致实际上种子已经在下载了，但MP没有获取到对应的信息，导致MP认为种子没有下载，从而随机标签没有被删除。

- **为什么我被标记H&R了，会不会被BAN号？**
  - 排除H&R并不保证能完全适配所有站点（部分站点在列表页不显示H&R标志，但实际上是有H&R的）。
  - H&R相关规则，请查看对应站点规则。

- **为什么明明选择只刷免费种，还是统计下载量了？**
  - 请检查是否被标记盒子。
  - 请检查种子免费期是否已结束。

- **为什么被标记盒子了，是不是开了代理下载种子？**
  - 代理下载种子是通过MP下载种子后推送到下载器，解决下载器无法正常访问种子地址，导致下载种子失败，无法正常获取到种子Hash的问题。
  - 该配置项不会导致被标盒，如出现标盒，请检查下载器网络环境。建议对该选项有充分认知后选择开启，如有任何疑问，请关闭该选项。

- **为什么开启了动态删除种子，把我的种子全部删除了？**
  - 该功能为实验性功能，删除规则还在逐步优化调整中，可能会导致刷流数据异常，甚至清空，请慎重开启。
  - 目前的删除规则为当做种体积超过设定的动态删除阈值时，执行种子删除规则，优先删除满足**用户设置删除规则**的**全部种子**，**即便在删除过程中已经低于了阈值下限，也会继续删除**。
  - 若删除后还没有达到阈值，则在已完成种子中排除H&R种子后按**做种时间倒序**进行删除。

- **为什么刷流插件不支持配置标签？**
  - 请使用「下载任务分类和标签」或「下载器助手」插件。

- **为什么种子明明在站点显示是免费的，但是在刷流日志中提示非免费种子，或者促销条件与站点对不上？**
  - 检查是否已经过了免费期限。
  - 尝试在MP中，进入站点管理->对应站点->浏览，找到对应的种子，查看促销条件是否与站点显示的一致。如不一致，可在 [MoviePilot](https://github.com/jxxghp/MoviePilot/issues) 反馈适配。

- **为什么配置了选种规则，却没有按选种规则执行？**
  - 请开启 `DEBUG` 日志，并按日志排查问题。
  - 部分种子可能在发布后修改相关内容，如促销条件、H&R等，请根据日志排查。
  - 尝试在MP中，进入站点管理->对应站点->浏览，找到对应的种子，查看相关内容与站点显示的一致。如不一致，可在 [MoviePilot](https://github.com/jxxghp/MoviePilot/issues) 反馈适配。
 
- **为什么刷流插件显示的种子信息与站点显示的信息不一致？**
  - 请开启 `DEBUG` 日志，并按日志排查问题。
  - 部分种子可能在发布后修改相关内容，如促销条件、H&R等，请根据日志排查。
  - 尝试在MP中，进入站点管理->对应站点->浏览，找到对应的种子，查看相关内容与站点显示的一致。如不一致，可在 [MoviePilot](https://github.com/jxxghp/MoviePilot/issues) 反馈适配。

- **为什么配置了保存目录，还是保存到QB的默认下载目录了？**
  - 请检查下载器是否开启了「自动分类管理」，开启后，下载目录由QB进行管理，「保存目录」配置项将会失效。请提前在QB配置。

![](../../images/2024-05-02-03-16-42.png)
